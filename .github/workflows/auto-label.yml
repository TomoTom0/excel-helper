name: Auto Label PR

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  pull-requests: write
  contents: read

jobs:
  auto-label:
    runs-on: ubuntu-latest
    steps:
      - name: Auto-label based on branch name
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const branchName = context.payload.pull_request.head.ref;
            const prTitle = context.payload.pull_request.title;
            const prBody = context.payload.pull_request.body || '';
            
            const labelsToAdd = [];
            
            // ãƒ–ãƒ©ãƒ³ãƒåã‹ã‚‰ãƒ©ãƒ™ãƒ«æŽ¨è«–
            if (branchName.startsWith('feat/') || branchName.startsWith('feature/')) {
              labelsToAdd.push('type/feature', 'version/minor');
            } else if (branchName.startsWith('fix/')) {
              labelsToAdd.push('type/fix', 'version/patch');
            } else if (branchName.startsWith('docs/')) {
              labelsToAdd.push('type/docs', 'version/patch');
            } else if (branchName.startsWith('refactor/')) {
              labelsToAdd.push('type/refactor', 'version/patch');
            } else if (branchName.startsWith('test/')) {
              labelsToAdd.push('type/test');
            } else if (branchName.startsWith('ci/')) {
              labelsToAdd.push('type/ci');
            } else if (branchName.startsWith('chore/')) {
              labelsToAdd.push('type/chore');
            } else if (branchName.startsWith('hotfix/')) {
              labelsToAdd.push('type/fix', 'version/patch', 'priority/high');
            } else if (branchName.startsWith('breaking/')) {
              labelsToAdd.push('version/major');
            }
            
            // PRã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ç ´å£Šçš„å¤‰æ›´ã‚’æ¤œå‡º
            if (prTitle.includes('!:') || prTitle.toLowerCase().includes('breaking')) {
              labelsToAdd.push('version/major');
            }
            
            // PRãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰æŽ¨è«–
            if (prBody.includes('[x] ðŸš€ æ–°æ©Ÿèƒ½')) {
              labelsToAdd.push('type/feature', 'version/minor');
            }
            if (prBody.includes('[x] ðŸ› ãƒã‚°ä¿®æ­£')) {
              labelsToAdd.push('type/fix', 'version/patch');
            }
            if (prBody.includes('[x] ðŸ“ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ')) {
              labelsToAdd.push('type/docs', 'version/patch');
            }
            if (prBody.includes('[x] â™»ï¸ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°')) {
              labelsToAdd.push('type/refactor', 'version/patch');
            }
            if (prBody.includes('[x] âš ï¸ ç ´å£Šçš„å¤‰æ›´')) {
              labelsToAdd.push('version/major');
            }
            if (prBody.includes('[x] âœ… ãƒ†ã‚¹ãƒˆ')) {
              labelsToAdd.push('type/test');
            }
            if (prBody.includes('[x] ðŸ”§ CI/CD')) {
              labelsToAdd.push('type/ci');
            }
            if (prBody.includes('[x] ðŸ§¹ é›‘å‹™')) {
              labelsToAdd.push('type/chore');
            }
            
            // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ã®å„ªå…ˆåº¦å‡¦ç†ï¼ˆmajor > minor > patchï¼‰
            const versionLabels = labelsToAdd.filter(l => l.startsWith('version/'));
            if (versionLabels.length > 1) {
              if (versionLabels.includes('version/major')) {
                labelsToAdd.splice(labelsToAdd.indexOf('version/minor'), 1);
                labelsToAdd.splice(labelsToAdd.indexOf('version/patch'), 1);
              } else if (versionLabels.includes('version/minor')) {
                labelsToAdd.splice(labelsToAdd.indexOf('version/patch'), 1);
              }
            }
            
            // é‡è¤‡å‰Šé™¤
            const uniqueLabels = [...new Set(labelsToAdd)];
            
            if (uniqueLabels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: uniqueLabels
              });
              
              console.log(`Added labels: ${uniqueLabels.join(', ')}`);
            } else {
              console.log('No labels to add');
            }
